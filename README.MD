# Комплексная задача «Бонусный сервер»

## Легенда

Клиент — сеть продуктовых магазинов, запустили доставку продуктов через интернет. Заказы фиксируются в CRM Битрикс24 в направлении сделок
«доставка продуктов». Требуется реализовать бонусную программу для постоянных покупателей.

## Ожидаемая архитектура разрабатываемой системы

Общее описание взаимодействия систем на уровне сущностей и потоков данных необходимое для понимания бизнес-целей заказчика.

- в качестве интерфейса к заказам и клиентам используется Битрикс24.
- клиенты хранятся в CRM Б24 в сущности Контакты, заказы хранятся в сделках.
- табличная часть заказа не имеет связи с продуктами.
- бонусные начисления применяются в виде монетарной скидки к табличной части сделки изменяя сумму сделки
- как только контакт создаётся в Битрикс24, то ему назначается карта в приложении
- бонусы начисляются при успешном закрытии сделки, если по ней не было произведено частичной оплаты

## Интервью с заказчиком

Заказчику были сформулированы и заданы [вопросы](documentation/interview_with_customer.MD). Из них можно собрать требования к
разрабатываемой системе.

## Порядок выполнения работ

Что нужно сделать для успешного выполнения задачи.

### Подготовка рабочего окружения — настройка Битрикс24

1. Сделать чекаут репозитория в своём рабочем окружении и периодически его обновлять
2. Зарегистрировать аккаунт в Битрикс24 и создать свой портал Битрикс24
3. Включить тестовый период на 1 месяц в настройках портала
4. Включить тестовый период на 1 месяц для приложений «по подписке»
5. Создать направление сделок «delivery»
6. Создать стадию сделок «bonus_payment»
7. Добавить CRM-робот «вебхук» на стадию «bonus_payment»
8. Зарегистрировать «ВХОДЯЩИЙ» вебхук в разделе «для разработчиков» с правами «CRM»
9. Поставить из маркетплейса приложение «документация по REST-API»

### Подготовка рабочего окружения — сервер приложения

1. Сделать публично-доступный хост в интернете с поддержкой https
2. Убедиться, что вебхуки от Битрикс24 доходят до этого хоста
3. Убедиться, что PHP позволяет делать запросы в ваш Б24 через REST-API используя ваш вебхук

### Разработка

Написать код, который реализует бизнес-требования заказчика

### Самостоятельное тестирование

1. написать тесты для проверки разработанного функционала
2. можно использовать генератор демо-данных по сделкам

### Автоматическое приёмочное тестирование

1. Изменить параметры подключения на свой портал для интеграционных тестов
2. Убедиться, что все тесты проходят и зелёные

### Подготовка презентации к защите

### Защита проекта

1. Сделать презентацию проекта не более 10 слайдов.
2. Отрепетировать рассказ по проекту длительностью 10 минут + 5 минут ответы на вопросы.
3. Защитить проект

## Критерии выполнения задачи

### Технические требования к проекту

1. Алгоритм применения скидки к заказу реализовать в виде отдельного класса и покрыть его юнит-тестами
2. Версия PHP - 7.4
3. Можно использовать сторонние библиотеки или компоненты, желательно из экосистемы фреймворка Symfony
4. Разработанная система удовлетворяет всем требованиям описанным в разделе «требования по проекту» которые сформулировал на основании
   интервью исполнитель.
5. Система проходит интеграционные тесты которые представляют собой набор заранее заготовленных тестовых данных: сделки с табличными частями
   до и после применения скидок, результаты начисления бонусов.
6. Статический анализатор кода [PHPStan](https://phpstan.org/user-guide/rule-levels) не показывает ошибок в вашем коде, уровень проверки - 6

## Информация для самостоятельного изучения

- REST-API по работе с Битрикс24 https://dev.1c-bitrix.ru/rest_help/

## Консольные утилиты для работы с проектом

- `demo:contacts` – генерация тестовых клиентов
- `demo:deals` – генерация тестовых сделок связанных с существующими клиентами 